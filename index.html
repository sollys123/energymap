<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µåŠ›å¸‚åœºç»¼åˆçƒ­åŠ›å›¾</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. React å…¨å®¶æ¡¶ (Staticfile CDN) -->
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Staticfile CDN) -->
    <script src="https://cdn.staticfile.net/babel-standalone/7.22.20/babel.min.js"></script>
    
    <!-- 4. ECharts (Staticfile CDN) -->
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
            const { useState, useEffect, useRef, useMemo } = React;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const X = (props) => (<IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>);
        const Activity = (props) => (<IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>);
        const TrendingUp = (props) => (<IconWrapper {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconWrapper>);
        const BarChart3 = (props) => (<IconWrapper {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconWrapper>);
        const Coins = (props) => (<IconWrapper {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconWrapper>);
        const Zap = (props) => (<IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>);
        const ArrowLeft = (props) => (<IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>);
        const MapIcon = (props) => (<IconWrapper {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconWrapper>);
        const ChevronLeft = (props) => (<IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>);
        const ChevronRight = (props) => (<IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>);
        const Layers = (props) => (<IconWrapper {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconWrapper>);
        const BatteryCharging = (props) => (<IconWrapper {...props}><path d="M5 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3.19M15 6h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3.19"/><line x1="23" x2="23" y1="13" y2="11"/><polyline points="11 6 7 12 13 12 9 18"/></IconWrapper>);

        const EnergyMarketMap = () => {
            const mapContainerRef = useRef(null);
            const chartInstanceRef = useRef(null);
            
            // --- æ ¸å¿ƒçŠ¶æ€ ---
            const [marketType, setMarketType] = useState('frequency'); // 'frequency' (äºŒæ¬¡è°ƒé¢‘) | 'energy' (ç”µèƒ½é‡)
            const [energyView, setEnergyView] = useState('price'); // 'price' | 'policy-long' | 'policy-spot'
            const [viewMode, setViewMode] = useState('china'); // 'china' | 'province'
            const [currentProvince, setCurrentProvince] = useState(null);
            const [selectedProvinceInfo, setSelectedProvinceInfo] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);

            // --- çœä»½ Adcode æ˜ å°„ ---
            const adcodeMap = {
                'æ²³åŒ—çœ': 130000, 'å±±è¥¿çœ': 140000, 'å¹¿ä¸œçœ': 440000,
                'ç”˜è‚ƒçœ': 620000, 'æ²³å—çœ': 410000, 'å®å¤å›æ—è‡ªæ²»åŒº': 640000,
                'æ±Ÿè‹çœ': 320000, 'æµ™æ±Ÿçœ': 330000, 'é™•è¥¿çœ': 610000,
                'åŒ—äº¬å¸‚': 110000, 'å¤©æ´¥å¸‚': 120000, 'å±±ä¸œçœ': 370000,
                'å®‰å¾½çœ': 340000, 'ç¦å»ºçœ': 350000, 'ä¸Šæµ·å¸‚': 310000,
                'æ¹–åŒ—çœ': 420000, 'æ¹–å—çœ': 430000, 'æ±Ÿè¥¿çœ': 360000,
                'å‰æ—çœ': 220000, 'é»‘é¾™æ±Ÿçœ': 230000, 'è¾½å®çœ': 210000,
                'å†…è’™å¤è‡ªæ²»åŒº': 150000, 'é’æµ·çœ': 630000, 'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 650000,
                'å››å·çœ': 510000, 'é‡åº†å¸‚': 500000, 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 450000,
                'è´µå·çœ': 520000, 'äº‘å—çœ': 530000, 'æµ·å—çœ': 460000
            };

            // --- é…ç½®å®šä¹‰ ---
            
            // 1. é¢œè‰²é…ç½® (æ ¹æ®å¸‚åœºç±»å‹åˆ‡æ¢)
            const colorPalettes = {
                frequency: {
                    // çº¢/æ©™/é»„æš–è‰²ç³» (ä»£è¡¨çƒ­åº¦/æ”¶ç›Š)
                    map: ['#991b1b', '#dc2626', '#ea580c', '#fbbf24', '#fef08a'],
                    highlight: '#d97706',
                    iconBg: 'bg-red-50', iconText: 'text-red-600', iconBorder: 'border-red-100',
                    gradientFrom: 'from-red-600', gradientTo: 'to-orange-500'
                },
                energy: {
                    // è“è‰²ç³» (ä»£è¡¨ç”µé‡/è´Ÿè·)
                    map: ['#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd', '#e0f2fe'],
                    highlight: '#38bdf8',
                    iconBg: 'bg-sky-50', iconText: 'text-sky-600', iconBorder: 'border-sky-100',
                    gradientFrom: 'from-sky-500', gradientTo: 'to-cyan-400'
                }
            };

            const currentPalette = colorPalettes[marketType];

            // 2. ç‚¹ä½ç±»å‹é…ç½®
            const pointTypeConfig = {
                'N': { color: '#22c55e', symbol: 'circle', label: 'æ–°èƒ½æº (é£/å…‰)', beltColor: '#86efac' },
                'F': { color: '#7e22ce', symbol: 'rect', label: 'ç«ç”µ/ç…¤ç”µ', beltColor: '#d8b4fe' },
                'S': { color: '#0ea5e9', symbol: 'triangle', label: 'è°ƒèŠ‚/æ°´ç”µ/æ ¸ç”µ', beltColor: '#7dd3fc' },
                // ç”µèƒ½é‡å¸‚åœºå¯èƒ½ç”¨åˆ°çš„æ–°ç±»å‹ (é¢„ç•™)
                'L': { color: '#f59e0b', symbol: 'diamond', label: 'è´Ÿè·ä¸­å¿ƒ', beltColor: '#fcd34d' } 
            };

            // --- æ•°æ®æº ---

            // A. äºŒæ¬¡è°ƒé¢‘æ•°æ® (Frequency Data) - æ²¿ç”¨ä¹‹å‰çš„æ•°æ®
            const frequencyData = {
                mapValues: {
                    'æ²³åŒ—çœ': 5000, 'æ²³å—çœ': 4000, 'å¹¿ä¸œçœ': 5000, 
                    'å±±è¥¿çœ': 4100, 'ç”˜è‚ƒçœ': 2500, 'å®å¤å›æ—è‡ªæ²»åŒº': 500
                },
                details: {
                    'æ²³åŒ—çœ': {
                        title: 'æ²³åŒ—çœ (å—ç½‘)', totalVolume: '5000ä¸‡å…ƒ (å‚¨èƒ½ä»½é¢)',
                        marketVolumeDisplay: 'æ¯æœˆå‚¨èƒ½åˆ†æ‘Šä»½é¢çº¦ 5000ä¸‡å…ƒ',
                        tags: ['çƒ­åº¦æœ€é«˜', '2026å¼€æ”¾'],
                        details: [{ label: 'æ•°æ®æ¥æº', value: 'æ²³åŒ—å—ç½‘äº¤æ˜“ä¸­å¿ƒå¸‚åœºå¤„ä¸»ä»»' }]
                    },
                    'æ²³å—çœ': {
                        title: 'æ²³å—çœ', totalVolume: '4000ä¸‡å…ƒ (å‚¨èƒ½ä»½é¢)',
                        marketVolumeDisplay: 'æ¯æœˆå‚¨èƒ½åˆ†æ‘Šä»½é¢çº¦ 4000ä¸‡å…ƒ',
                        tags: ['çƒ­åº¦é«˜', '2027å¼€æ”¾'],
                        details: [{ label: 'æ•°æ®æ¥æº', value: 'æ²³å—è°ƒåº¦è®¡åˆ’å¤„ä¸»ä»»' }]
                    },
                    'å¹¿ä¸œçœ': {
                        title: 'å¹¿ä¸œçœ', totalVolume: '5000ä¸‡å…ƒ',
                        marketVolumeDisplay: 'æ¯æœˆç‹¬ç«‹å‚¨èƒ½å¸‚åœºæ€»é‡ 5000ä¸‡å…ƒå·¦å³',
                        tags: ['æ•°æ®è¯¦å®', 'æ”¶ç›Šå æ¯”90%'],
                        details: [{ label: 'æ•°æ®æ¥æº', value: '5-7æœˆæ”¶ç›Šè¡¨' }]
                    },
                    'å±±è¥¿çœ': {
                        title: 'å±±è¥¿çœ', totalVolume: '4100ä¸‡å…ƒ',
                        marketVolumeDisplay: 'æ¯æœˆå¸‚åœºæ€»é‡ 4100ä¸‡å…ƒ',
                        tags: ['å¸‚åœºæˆç†Ÿ', 'å æ¯”80%'],
                        details: [{ label: 'æ•°æ®æ¥æº', value: 'å®åœ°è°ƒç ” (1-3æœˆæ”¶ç›Šè¡¨)' }]
                    },
                    'ç”˜è‚ƒçœ': {
                        title: 'ç”˜è‚ƒçœ', totalVolume: '2500ä¸‡å…ƒ',
                        marketVolumeDisplay: 'æ¯æœˆå…¨å¸‚åœºè°ƒé¢‘æ€»é‡‘é¢ 2500-2600ä¸‡å…ƒ',
                        tags: ['è¶‹åŠ¿ä¸Šæ¶¨', 'åŠå…¬å¼€æŠ«éœ²'],
                        details: [{ label: 'æ•°æ®æ¥æº', value: 'ç”˜è‚ƒç”µåŠ›äº¤æ˜“ä¸­å¿ƒåŠå…¬å¼€æŠ«éœ²ä¿¡æ¯' }]
                    },
                    'å®å¤å›æ—è‡ªæ²»åŒº': {
                        title: 'å®å¤å›æ—è‡ªæ²»åŒº', totalVolume: '500ä¸‡å…ƒ',
                        marketVolumeDisplay: 'æ¯æœˆæ€»é‡ 500ä¸‡å…ƒå·¦å³',
                        tags: ['æ¶¨å¹…ä¸å¤§', 'å æ¯”5%'],
                        details: [{ label: 'æ•°æ®æ¥æº', value: 'å®åœ°è°ƒç ”' }]
                    }
                },
                provincePoints: {
                    'ç”˜è‚ƒçœ': [
                        { name: 'é™‡ä¸œåŸºåœ°', coord: [107.63, 35.73], type: 'F', label: 'é™‡ä¸œç…¤ç”µåŸºåœ°', desc: 'å‘å£ç…¤ç”µ+å¤–é€ä¸­å¿ƒ' },
                        { name: 'åˆ˜å®¶å³¡', coord: [103.35, 35.93], type: 'S', label: 'é»„æ²³æ¢¯çº§æ°´ç”µ', desc: 'åˆ˜å®¶å³¡è°ƒå³°ä¸»åŠ›' }
                    ],
                    'å®å¤å›æ—è‡ªæ²»åŒº': [
                        { name: 'å®ä¸œåŸºåœ°', coord: [106.66, 38.16], type: 'F', label: 'å®ä¸œèƒ½æºåŒ–å·¥', desc: 'ç…¤ç”µ+åŒ–å·¥+å…‰ä¼' },
                        { name: 'è…¾æ ¼é‡Œ', coord: [105.00, 37.60], type: 'N', label: 'è…¾æ ¼é‡ŒåŸºåœ°', desc: 'æ²™æ¼ å…‰ä¼/é£ç”µ' },
                        { name: 'ä¸­å®æ¢æµç«™', coord: [105.67, 37.48], type: 'S', label: 'ä¸­å®æ¢æµç«™', desc: 'å®ç”µå…¥æ¹˜é€ç«¯' }
                    ],
                    'æ²³å—çœ': [
                        { name: 'å¹³é¡¶å±±', coord: [113.19, 33.76], type: 'F', label: 'å¹³é¡¶å±±ç…¤ç”µ', desc: 'ä¸­åŸç…¤ç”µä¸­å¿ƒ' },
                        { name: 'è±«è¥¿é£ç”µ', coord: [111.50, 34.50], type: 'N', label: 'è±«è¥¿é£ç”µ', desc: 'æ´›é˜³è¥¿éƒ¨å±±åŒº' },
                        { name: 'è±«ä¸œå…‰ä¼', coord: [114.50, 34.60], type: 'N', label: 'è±«ä¸œå…‰ä¼', desc: 'å¼€å°å‘¨è¾¹é›†ä¸­å¼' }
                    ],
                    'æ²³åŒ—çœ': [
                        { name: 'çŸ³å®¶åº„', coord: [114.48, 38.03], type: 'F', label: 'çŸ³å®¶åº„çƒ­ç”µ', desc: 'çœä¼šè´Ÿè·ä¸­å¿ƒ' },
                        { name: 'å†€å—å…‰ä¼', coord: [115.68, 37.73], type: 'N', label: 'å†€å—å…‰ä¼', desc: 'è¡¡æ°´å¹³åŸå…‰ä¼å¸¦' }
                    ],
                    'å¹¿ä¸œçœ': [
                        { name: 'ç²¤è¥¿ç…¤ç”µ', coord: [110.35, 21.27], type: 'F', label: 'ç²¤è¥¿ç…¤ç”µ', desc: 'æ¹›æ±Ÿæ²¿æµ·åŸºåœ°' },
                        { name: 'ç²¤ä¸œç…¤ç”µ', coord: [116.37, 23.55], type: 'F', label: 'ç²¤ä¸œç…¤ç”µ', desc: 'æ­é˜³/æƒ æ¥åŸºåœ°' },
                        { name: 'é˜³æ±Ÿé£ç”µ', coord: [111.98, 21.4], type: 'N', label: 'é˜³æ±Ÿæµ·ä¸Šé£ç”µ', desc: 'è¿‘æµ·é£ç”µé›†ç¾¤' },
                        { name: 'æ±•å°¾é£ç”µ', coord: [115.6, 22.6], type: 'N', label: 'æ±•å°¾æµ·ä¸Šé£ç”µ', desc: 'ç”²å­æµ·åŸŸ' }
                    ]
                },
                provinceBelts: {
                    'ç”˜è‚ƒçœ': [{ name: 'æ²³è¥¿èµ°å»Šæ–°èƒ½æºå¸¦', type: 'N', coords: [[98.50, 39.75], [96.5, 40.5]], label: 'é…’æ³‰-ç“œå·-ç‰é—¨ åŸºåœ°å¸¦' }],
                    'æ²³å—çœ': [{ name: 'è±«åŒ—ç…¤ç”µå¸¦', type: 'F', coords: [[114.35, 36.10], [114.29, 35.74]], label: 'å®‰é˜³-é¹¤å£ ç…¤ç”µå¸¦' }],
                    'æ²³åŒ—çœ': [{ name: 'å†€å—é’¢é“ç…¤ç”µå¸¦', type: 'F', coords: [[114.50, 37.06], [114.47, 36.60]], label: 'é‚¢å°-é‚¯éƒ¸ ç…¤ç”µé’¢é“å¸¦' }],
                    'å¹¿ä¸œçœ': [{ name: 'ç æ±Ÿå£æ ¸ç”µèµ°å»Š', type: 'S', coords: [[112.93, 21.92], [114.54, 22.60], [114.8, 22.7]], label: 'ç æ±Ÿå£æ ¸ç”µèµ°å»Š' }]
                }
            };

            // B. ç”µèƒ½é‡æ•°æ® (Energy Data)
            const rawEnergyPriceData = {
                'åŒ—äº¬å¸‚': { range: [0.318, 0.596], display: '0.318~0.596 å…ƒ/kWh', note: 'ååŒ—ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'å¤©æ´¥å¸‚': { value: 0.51, display: '0.51 å…ƒ/kWh', note: 'ååŒ—ï¼šå•æ¬¡è°·å……å³°æ”¾æµ‹ç®—', category: 'market' },
                'æ²³åŒ—çœ': { range: [0.43, 0.6], display: '0.43â€“0.6 å…ƒ/kWh', note: 'ä¸¤å……ä¸¤æ”¾ä»·å·®çº¦ 0.43ï¼›ä¸€å……ä¸€æ”¾çº¦ 0.6', category: 'actual' },
                'å±±ä¸œçœ': { value: 0.601, display: '0.601 å…ƒ/kWh', note: 'ååŒ—ï¼šå•æ¬¡è°·å……å³°æ”¾', category: 'market' },
                'å±±è¥¿çœ': { value: 0.45, display: '0.45 å…ƒ/kWh', note: 'ååŒ—ï¼šæµ‹ç®—ä»·å·®', category: 'actual' },
                'å®‰å¾½çœ': { range: [0.257, 0.607], display: '0.257~0.607 å…ƒ/kWh', note: 'åä¸œï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'ç¦å»ºçœ': { range: [0.216, 0.452], display: '0.216~0.452 å…ƒ/kWh', note: 'åä¸œï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'ä¸Šæµ·å¸‚': { value: 0.679, display: '0.679 å…ƒ/kWhï¼ˆåªèƒ½åšä¸€æ¬¡è°·å……å³°æ”¾ï¼‰', note: 'åä¸œï¼šå•æ¬¡æ“ä½œ', category: 'market' },
                'æ±Ÿè‹çœ': { value: 0.2, display: '0.2 å…ƒ/kWh', note: 'åä¸œï¼šå®æµ‹ä»·å·®', category: 'actual' },
                'æµ™æ±Ÿçœ': { value: 0.1, display: '0.1 å…ƒ/kWh', note: 'åä¸œï¼šå®æµ‹ä»·å·®', category: 'actual' },
                'æ²³å—çœ': { value: 0.4, display: '0.4 å…ƒ/kWh', note: 'åä¸­ï¼šå®æµ‹ä»·å·®', category: 'actual' },
                'æ¹–åŒ—çœ': { range: [0.229, 0.562], display: '0.229~0.562 å…ƒ/kWhï¼ˆå…¨å¹´ 2 å°æ—¶å°–å³°ï¼‰', note: 'åä¸­ï¼šä¸¤å°æ—¶å°–å³°çª—å£', category: 'market' },
                'æ¹–å—çœ': { range: [0.246, 0.492], display: '0.246~0.492 å…ƒ/kWh', note: 'åä¸­ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'æ±Ÿè¥¿çœ': { range: [0.273, 0.547], display: '0.273~0.547 å…ƒ/kWh', note: 'åä¸­ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'å‰æ—çœ': { value: 0.469, display: '0.469 å…ƒ/kWh', note: 'ä¸œåŒ—ï¼šå•æ¬¡è°·å……å³°æ”¾', category: 'market' },
                'é»‘é¾™æ±Ÿçœ': { value: 0.395, display: '0.395 å…ƒ/kWh', note: 'ä¸œåŒ—ï¼šå•æ¬¡è°·å……å³°æ”¾', category: 'market' },
                'è¾½å®çœ': { value: 0.423, display: '0.423 å…ƒ/kWh', note: 'ä¸œåŒ—ï¼šå•æ¬¡è°·å……å³°æ”¾', category: 'market' },
                'å†…è’™å¤è‡ªæ²»åŒº': { range: [0.223, 0.407], display: 'è’™ä¸œï¼š0.342ï¼›è’™è¥¿ï¼š0.223~0.407 å…ƒ/kWh', note: 'è’™ä¸œå…¨å¹´ä¸¤æ¬¡è°·æ®µå……ç”µ + é«˜å³°æ”¾ç”µï¼›è’™è¥¿ä¸ºå³°è°·åŒºé—´', category: 'market' },
                'ç”˜è‚ƒçœ': { value: 0.27, display: '0.27 å…ƒ/kWhï¼ˆæ²³è¥¿å‡ä»·çº¦ 0.27ï¼‰', note: '454 ä¸ªèŠ‚ç‚¹ï¼Œæ²³è¥¿å‡ä»·çº¦ 0.27', category: 'actual' },
                'å®å¤å›æ—è‡ªæ²»åŒº': { value: 0.32, display: '0.32 å…ƒ/kWhï¼ˆå¯åšé‡‘èå¥—åˆ©ï¼‰', note: 'å¯åšé‡‘èå¥—åˆ©', category: 'actual' },
                'é’æµ·çœ': { range: [0.231, 0.455], display: '0.231~0.455 å…ƒ/kWh', note: 'è¥¿åŒ—ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'é™•è¥¿çœ': { value: 0.4, display: '0.4 å…ƒ/kWh', note: 'è¥¿åŒ—ï¼šå®æµ‹ä»·å·®', category: 'actual' },
                'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': { range: [0.136, 0.290], display: '0.136~0.290 å…ƒ/kWh', note: 'è¥¿åŒ—ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'å››å·çœ': { range: [0.166, 0.332], display: '0.166~0.332 å…ƒ/kWh', note: 'è¥¿å—ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'é‡åº†å¸‚': { range: [0.262, 0.533], display: '0.262~0.533 å…ƒ/kWh', note: 'è¥¿å—ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'å¹¿ä¸œçœ': { value: 0.18, display: '0.18 å…ƒ/kWh', note: 'å—ç½‘ï¼šå®æµ‹ä»·å·®', category: 'actual' },
                'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': { range: [0.205, 0.411], display: '0.205~0.411 å…ƒ/kWh', note: 'å—ç½‘ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'è´µå·çœ': { range: [0.231, 0.463], display: '0.231~0.463 å…ƒ/kWh', note: 'å—ç½‘ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' },
                'äº‘å—çœ': { value: 0.28, display: '0.28 å…ƒ/kWh', note: 'å—ç½‘ï¼šå•æ¬¡è°·å……å³°æ”¾', category: 'market' },
                'æµ·å—çœ': { range: [0.397, 0.737], display: '0.397~0.737 å…ƒ/kWh', note: 'å—ç½‘ï¼šå³°è°·ä»·å·®åŒºé—´', category: 'market' }
            };

            const buildEnergyData = () => {
                const mapValues = {};
                const details = {};
                const categoryMap = {};
                const displayMap = {};
                const noteMap = {};
                const rangeMap = {};
                const actualValues = [];
                const marketValues = [];

                Object.entries(rawEnergyPriceData).forEach(([name, info]) => {
                    const midValue = info.value ?? (((info.range?.[0] || 0) + (info.range?.[1] || 0)) / 2);
                    mapValues[name] = midValue;
                    categoryMap[name] = info.category;
                    displayMap[name] = info.display;
                    noteMap[name] = info.note;
                    rangeMap[name] = info.range;
                    (info.category === 'actual' ? actualValues : marketValues).push(midValue);

                    details[name] = {
                        title: `${name} ç”µèƒ½é‡ä»·å·®`,
                        totalVolume: info.display,
                        marketVolumeDisplay: info.note ? `${info.display} ï½œ ${info.note}` : info.display,
                        tags: [info.category === 'actual' ? 'å®æµ‹æ•°æ®' : 'å¸‚åœºåŒºé—´', info.range ? 'æä¾›èŒƒå›´' : 'å•ç‚¹æ•°æ®'],
                        details: [
                            { label: 'ä»·æ ¼/ä»·å·®', value: info.display },
                            ...(info.range ? [{ label: 'èŒƒå›´æ•°å€¼', value: `${info.range[0]} ~ ${info.range[1]} å…ƒ/kWh` }] : []),
                            info.note ? { label: 'å¤‡æ³¨', value: info.note } : null
                        ].filter(Boolean)
                    };
                });

                const calcRange = (values) => {
                    if (!values.length) return { min: 0, max: 1 };
                    return { min: Math.min(...values), max: Math.max(...values) };
                };

                return {
                    mapValues,
                    details,
                    categoryMap,
                    displayMap,
                    noteMap,
                    rangeMap,
                    ranges: {
                        actual: calcRange(actualValues),
                        market: calcRange(marketValues)
                    }
                };
            };

            const energyData = buildEnergyData();

            // --- ç”µèƒ½é‡æ”¿ç­–è¿›ç¨‹æ•°æ® ---
            const policyLevelLabel = {
                1: 'æ— æ”¿ç­–',
                2: 'ç»è¥ä¸»ä½“åŒ…å«å‚¨èƒ½',
                3: 'äº¤æ˜“ç»†åˆ™åŒ…å«å‚¨èƒ½'
            };

            const normalizeProvinceName = (name) => {
                const map = {
                    'æ²³åŒ—å—ç½‘': 'æ²³åŒ—çœ',
                    'å†€åŒ—': 'æ²³åŒ—çœ'
                };
                if (map[name]) return map[name];
                if (/çœ$|å¸‚$|è‡ªæ²»åŒº$/.test(name)) return name;
                if (['åŒ—äº¬', 'å¤©æ´¥', 'ä¸Šæµ·', 'é‡åº†'].includes(name)) return `${name}å¸‚`;
                return `${name}çœ`;
            };

            const buildPolicyData = (rawList, policyTag) => {
                const mapValues = {};
                const details = {};
                const aliasMap = {};

                rawList.forEach(({ name, value }) => {
                    const provinceName = normalizeProvinceName(name);
                    mapValues[provinceName] = Math.max(mapValues[provinceName] || 0, value);
                    aliasMap[provinceName] = aliasMap[provinceName] ? [...aliasMap[provinceName], name] : [name];
                });

                Object.entries(mapValues).forEach(([province, value]) => {
                    const aliases = aliasMap[province] || [];
                    const aliasText = aliases.length > 1 ? `è¦†ç›–åŒºåŸŸï¼š${aliases.join('ã€')}` : (aliases[0] || province);
                    details[province] = {
                        title: `${province}æ”¿ç­–è¿›ç¨‹`,
                        totalVolume: `ç­‰çº§ ${value}`,
                        tags: [policyTag, policyLevelLabel[value] || 'æœªçŸ¥'],
                        heatValue: value,
                        details: [
                            { label: 'æ”¿ç­–ç±»å‹', value: policyTag },
                            { label: 'å½“å‰çŠ¶æ€', value: policyLevelLabel[value] || 'æœªçŸ¥' },
                            { label: 'å¤‡æ³¨', value: aliasText }
                        ]
                    };
                });

                return { mapValues, details, aliasMap, policyTag };
            };

            const rawPolicyLong = [
                { name: 'åŒ—äº¬', value: 2 }, { name: 'å¤©æ´¥', value: 2 }, { name: 'æ²³åŒ—å—ç½‘', value: 2 }, { name: 'å†€åŒ—', value: 2 },
                { name: 'å±±ä¸œ', value: 1 }, { name: 'å±±è¥¿', value: 2 }, { name: 'å®‰å¾½', value: 2 }, { name: 'ç¦å»º', value: 2 },
                { name: 'ä¸Šæµ·', value: 2 }, { name: 'æ±Ÿè‹', value: 2 }, { name: 'æµ™æ±Ÿ', value: 2 }, { name: 'æ¹–åŒ—', value: 2 },
                { name: 'æ¹–å—', value: 2 }, { name: 'æ²³å—', value: 2 }, { name: 'æ±Ÿè¥¿', value: 1 }, { name: 'å‰æ—', value: 2 },
                { name: 'é»‘é¾™æ±Ÿ', value: 2 }, { name: 'è¾½å®', value: 2 }, { name: 'ç”˜è‚ƒ', value: 1 }, { name: 'å®å¤', value: 2 },
                { name: 'é’æµ·', value: 2 }, { name: 'é™•è¥¿', value: 2 }, { name: 'æ–°ç–†', value: 2 }, { name: 'å››å·', value: 2 },
                { name: 'é‡åº†', value: 1 }, { name: 'å¹¿ä¸œ', value: 2 }, { name: 'å¹¿è¥¿', value: 1 }, { name: 'è´µå·', value: 2 },
                { name: 'äº‘å—', value: 2 }, { name: 'æµ·å—', value: 2 }
            ];

            const rawPolicySpot = [
                { name: 'åŒ—äº¬', value: 3 }, { name: 'å¤©æ´¥', value: 3 }, { name: 'æ²³åŒ—å—ç½‘', value: 3 }, { name: 'å†€åŒ—', value: 3 },
                { name: 'å±±ä¸œ', value: 3 }, { name: 'å±±è¥¿', value: 3 }, { name: 'å®‰å¾½', value: 3 }, { name: 'ç¦å»º', value: 3 },
                { name: 'ä¸Šæµ·', value: 3 }, { name: 'æ±Ÿè‹', value: 3 }, { name: 'æµ™æ±Ÿ', value: 3 }, { name: 'æ¹–åŒ—', value: 3 },
                { name: 'æ¹–å—', value: 3 }, { name: 'æ²³å—', value: 3 }, { name: 'æ±Ÿè¥¿', value: 3 }, { name: 'å‰æ—', value: 3 },
                { name: 'é»‘é¾™æ±Ÿ', value: 3 }, { name: 'è¾½å®', value: 3 }, { name: 'ç”˜è‚ƒ', value: 3 }, { name: 'å®å¤', value: 3 },
                { name: 'é’æµ·', value: 3 }, { name: 'é™•è¥¿', value: 3 }, { name: 'æ–°ç–†', value: 3 }, { name: 'å››å·', value: 3 },
                { name: 'é‡åº†', value: 3 }, { name: 'å¹¿ä¸œ', value: 3 }, { name: 'å¹¿è¥¿', value: 3 }, { name: 'è´µå·', value: 3 },
                { name: 'äº‘å—', value: 3 }, { name: 'æµ·å—', value: 3 }
            ];

            const policyLongData = buildPolicyData(rawPolicyLong, 'ä¸­é•¿æœŸæ”¿ç­–');
            const policySpotData = buildPolicyData(rawPolicySpot, 'ç°è´§æ”¿ç­–');

            // --- è¾…åŠ©æ•°æ® ---
            const deepBlueProvinces = ['æ±Ÿè‹çœ', 'æµ™æ±Ÿçœ', 'å®‰å¾½çœ', 'å±±ä¸œçœ'];
            const blueProvinces = ['è´µå·çœ', 'äº‘å—çœ', 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº', 'æ¹–å—çœ', 'æ¹–åŒ—çœ', 'æ±Ÿè¥¿çœ', 'å†…è’™å¤è‡ªæ²»åŒº'];
            const lightBlueProvinces = ['æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº', 'é»‘é¾™æ±Ÿçœ', 'å‰æ—çœ', 'è¾½å®çœ', 'é’æµ·çœ'];

            const actualDataProvinces = ['æ²³åŒ—çœ', 'å±±è¥¿çœ', 'æ±Ÿè‹çœ', 'æµ™æ±Ÿçœ', 'æ²³å—çœ', 'ç”˜è‚ƒçœ', 'å®å¤å›æ—è‡ªæ²»åŒº', 'é™•è¥¿çœ', 'å¹¿ä¸œçœ'];

            const energyColorScale = {
                actual: ['#fffbeb', '#fef3c7', '#fde68a', '#fbbf24', '#f59e0b'],
                market: ['#f0f9ff', '#bae6fd', '#7dd3fc', '#38bdf8', '#0ea5e9']
            };

            const policyColorScale = ['#eef2ff', '#c7d2fe', '#9aa5ff'];

            const getEnergyColor = (value, category) => {
                const palette = energyColorScale[category === 'actual' ? 'actual' : 'market'];
                const { min, max } = energyData.ranges[category === 'actual' ? 'actual' : 'market'];
                const safeSpan = max - min || 1;
                const ratio = Math.min(1, Math.max(0, safeSpan === 0 ? 0.5 : (value - min) / safeSpan));
                const idx = Math.min(palette.length - 1, Math.floor(ratio * (palette.length - 1)));
                return palette[idx];
            };

            const getPolicyColor = (value) => {
                const ratio = Math.min(1, Math.max(0, (value - 1) / 2));
                const idx = Math.min(policyColorScale.length - 1, Math.round(ratio * (policyColorScale.length - 1)));
                return policyColorScale[idx];
            };

            // --- æ•°æ®é€‰æ‹©é€»è¾‘ ---
            const currentData = useMemo(() => {
                if (marketType === 'frequency') return frequencyData;
                if (energyView === 'policy-long') return policyLongData;
                if (energyView === 'policy-spot') return policySpotData;
                return energyData;
            }, [marketType, energyView]);

            // --- æ•°æ®è½¬æ¢å‡½æ•° ---
            const convertPointData = (data) => {
                if(!data) return [];
                return data.map(item => {
                    const cfg = pointTypeConfig[item.type];
                    return {
                        name: item.name,
                        value: item.coord.concat(100),
                        symbol: cfg?.symbol || 'circle',
                        itemStyle: { 
                            color: cfg?.color || '#666', 
                            borderColor: '#fff', borderWidth: 2, shadowBlur: 5, shadowColor: 'rgba(0,0,0,0.5)' 
                        },
                        tooltipData: item
                    };
                });
            };
            const convertBeltBorderData = (data) => data ? data.map(item => ({ coords: item.coords, name: item.label })) : [];
            const convertBeltFillData = (data) => {
                if(!data) return [];
                return data.map(item => {
                    const cfg = pointTypeConfig[item.type];
                    return {
                        coords: item.coords,
                        lineStyle: { color: cfg?.beltColor || '#ccc' },
                        name: item.label,
                        tooltipData: { label: item.label, desc: 'åŒºåŸŸ/èµ°å»Š/äº§ä¸šå¸¦', type: item.type }
                    };
                });
            };
            
            // ç”Ÿæˆçƒ­åŠ›å›¾æ•°æ® (æ ¹æ®å½“å‰å¸‚åœºç±»å‹)
            const generateMapData = () => {
                const data = [];
                const values = currentData.mapValues || {};

                Object.keys(values).forEach(name => {
                    if (marketType === 'energy') {
                        if (energyView === 'policy-long' || energyView === 'policy-spot') {
                            const color = getPolicyColor(values[name]);
                            data.push({
                                name,
                                value: values[name],
                                itemStyle: { areaColor: color, borderColor: '#fff', borderWidth: 1.2 },
                                emphasis: { itemStyle: { areaColor: currentPalette.highlight } },
                                policyType: energyView
                            });
                        } else {
                            const category = energyData.categoryMap[name];
                            const color = getEnergyColor(values[name], category);
                            data.push({
                                name,
                                value: values[name],
                                itemStyle: { areaColor: color, borderColor: '#fff', borderWidth: 1.2 },
                                emphasis: { itemStyle: { areaColor: currentPalette.highlight } },
                                energyCategory: category
                            });
                        }
                    } else {
                        data.push({ name: name, value: values[name] });
                    }
                });

                // åªæœ‰åœ¨è°ƒé¢‘å¸‚åœºæ—¶æ‰æ˜¾ç¤ºè¿™äº›ç‰¹å®šçš„è“æ¢¯é˜ŸèƒŒæ™¯
                if (marketType === 'frequency') {
                    deepBlueProvinces.forEach(name => !values[name] && data.push({ name, value: -3 }));
                    blueProvinces.forEach(name => !values[name] && data.push({ name, value: -2 }));
                    lightBlueProvinces.forEach(name => !values[name] && data.push({ name, value: -1 }));
                }
                return data;
            };

            // --- åŠ è½½åœ°å›¾ ---
            const loadMap = async (mode, provinceName = null) => {
                setLoading(true);
                try {
                    let geoJsonUrl = 'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json';
                    let mapName = 'china';

                    if (mode === 'province' && provinceName) {
                        const adcode = adcodeMap[provinceName];
                        if (adcode) {
                            geoJsonUrl = `https://geo.datav.aliyun.com/areas_v3/bound/${adcode}_full.json`;
                            mapName = provinceName;
                        }
                    }

                    const response = await fetch(geoJsonUrl);
                    const geoJson = await response.json();
                    
                    if (!window.echarts) return;
                    
                    window.echarts.registerMap(mapName, geoJson);
                    
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.dispose();
                    }
                    
                    const chart = window.echarts.init(mapContainerRef.current);
                    chartInstanceRef.current = chart;

                    let option = {};

                    if (mode === 'china') {
                        // === å…¨å›½è§†å›¾ ===
                        const frequencyPieces = [
                            { min: 4900, label: '5000ä¸‡', color: currentPalette.map[0] },
                            { min: 4050, max: 4899, label: '4100ä¸‡', color: currentPalette.map[1] },
                            { min: 3000, max: 4049, label: '4000ä¸‡', color: currentPalette.map[2] },
                            { min: 1000, max: 2999, label: '2500ä¸‡', color: currentPalette.map[3] },
                            { min: 0, max: 999, label: '500ä¸‡', color: currentPalette.map[4] },
                            { value: -3, label: 'ç¬¬ä¸€æ¢¯é˜Ÿ', color: '#1d4ed8' },
                            { value: -2, label: 'ç¬¬äºŒæ¢¯é˜Ÿ', color: '#60a5fa' },
                            { value: -1, label: 'ç¬¬ä¸‰æ¢¯é˜Ÿ', color: '#bfdbfe' }
                        ];

                        option = {
                            backgroundColor: 'transparent',
                            grid: { left: '5%', right: '5%', top: '5%', bottom: '5%' },
                            tooltip: {
                                trigger: 'item',
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                borderColor: '#e2e8f0', borderWidth: 1, padding: 12, textStyle: { color: '#1e293b' },
                                formatter: (params) => {
                                    if (params.data?.policyType) {
                                        const levelLabel = policyLevelLabel[params.value] || 'æœªçŸ¥';
                                        const aliases = (policyLongData.aliasMap[params.name] || policySpotData.aliasMap[params.name] || []);
                                        const aliasLine = aliases.length ? `<div style="font-size:12px;color:#475569;margin-top:4px;">è¦†ç›–ï¼š${aliases.join('ã€')}</div>` : '';
                                        const tag = params.data.policyType === 'policy-long' ? 'ä¸­é•¿æœŸæ”¿ç­–' : 'ç°è´§æ”¿ç­–';
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                            + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">ç±»å‹ï¼š<span style="font-weight:bold; color:${currentPalette.map[1]};">${tag}</span></div>`
                                            + `<div style="font-size:12px; color:#0ea5e9; font-weight:600;">${levelLabel}</div>`
                                            + aliasLine
                                            + `<div style="font-size:12px; color:#0ea5e9; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px;">ğŸ–± ç‚¹å‡»è¿›å…¥è¯¦æƒ…</div>`;
                                    }
                                    if (params.data?.energyCategory) {
                                        const categoryLabel = params.data.energyCategory === 'actual' ? 'å®æµ‹æ•°æ®' : 'å¸‚åœºåŒºé—´';
                                        const display = energyData.displayMap[params.name] || params.value;
                                        const note = energyData.noteMap[params.name];
                                        const range = energyData.rangeMap[params.name];
                                        const rangeLine = range ? `<div style="font-size:12px;color:#475569;margin-top:4px;">èŒƒå›´æ•°å€¼ï¼š${range[0]} ~ ${range[1]} å…ƒ/kWh</div>` : '';
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                            + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">ç±»åˆ«ï¼š<span style="font-weight:bold; color:${currentPalette.map[1]};">${categoryLabel}</span></div>`
                                            + `<div style="font-size:12px; color:#0ea5e9; font-weight:600;">${display}</div>`
                                            + (note ? `<div style="font-size:12px; color:#64748b; margin-top:4px;">${note}</div>` : '')
                                            + rangeLine
                                            + `<div style="font-size:12px; color:#0ea5e9; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px;">ğŸ–± ç‚¹å‡»è¿›å…¥è¯¦æƒ…</div>`;
                                    }

                                    if (marketType === 'frequency') {
                                        if (!params.value) return `<div style="color:#94a3b8">${params.name} <br/>æš‚æ— æ•°æ®</div>`;
                                        let colorDot = `<span style="display:inline-block;margin-right:6px;border-radius:50%;width:8px;height:8px;background-color:${Array.isArray(params.color) ? params.color[params.color.length-1] : params.color};"></span>`;
                                        if (params.value > 0) {
                                            const info = currentData.details[params.name] || {};
                                            const volume = marketType === 'energy' ? (energyData.displayMap[params.name] || info.totalVolume || params.value) : (info.totalVolume || params.value);
                                            const note = marketType === 'energy' ? (energyData.noteMap[params.name] || info.marketVolumeDisplay || '') : (info.marketVolumeDisplay || '');
                                            const categoryLabel = marketType === 'energy' ? (energyData.categoryMap[params.name] === 'actual' ? 'å®æµ‹æ•°æ®' : 'å¸‚åœºåŒºé—´') : 'å¸‚åœºæ€»é‡';
                                            return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                                    + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">${colorDot} ${categoryLabel}: <span style="font-weight:bold; color:${currentPalette.map[1]};">${volume}</span></div>`
                                                    + (note ? `<div style="font-size:12px; color:#64748b; margin-bottom:4px;">${note}</div>` : '')
                                                    + `<div style="font-size:12px; color:#0ea5e9; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px;">ğŸ–± ç‚¹å‡»è¿›å…¥è¯¦æƒ…</div>`;
                                        }
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`;
                                    }
                                }
                            },
                            ...(marketType === 'frequency' ? { visualMap: { show: false, type: 'piecewise', pieces: frequencyPieces } } : {}),
                            series: [{
                                name: 'å¸‚åœºåˆ†å¸ƒ',
                                type: 'map',
                                map: 'china',
                                roam: true,
                                zoom: 1.2,
                                center: [104.114129, 37.550339],
                                label: { show: true, fontSize: 10, color: 'rgba(0,0,0,0.5)' },
                                itemStyle: { areaColor: '#f8fafc', borderColor: '#cbd5e1', borderWidth: 1 },
                                emphasis: { label: { show: true, color: '#fff' }, itemStyle: { areaColor: currentPalette.highlight } },
                                data: generateMapData(),
                                selectedMode: false
                            }]
                        };
                    } else {
                        // === çœä»½è§†å›¾ ===
                        const pPoints = (currentData.provincePoints || {})[provinceName] || [];
                        const pBelts = (currentData.provinceBelts || {})[provinceName] || [];

                        option = {
                            backgroundColor: 'transparent',
                            tooltip: {
                                trigger: 'item',
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                borderColor: '#e2e8f0', borderWidth: 1, padding: 12, textStyle: { color: '#1e293b' },
                                formatter: (params) => {
                                    if (params.seriesType === 'effectScatter' || (params.seriesType === 'lines' && params.seriesName === 'èƒ½æºèµ°å»Š')) {
                                        const d = params.data.tooltipData;
                                        const typeInfo = pointTypeConfig[d.type] || { label: 'æœªçŸ¥' };
                                        return `<div style="font-weight:bold; margin-bottom:2px; color:${params.color}">${d.label}</div>
                                                <div style="font-size:12px;color:#64748b; margin-bottom:4px;">${d.desc || ''}</div>
                                                <div style="font-size:10px;color:#94a3b8;">ç±»å‹: ${typeInfo.label}</div>`;
                                    }
                                    return params.name;
                                }
                            },
                            geo: {
                                map: mapName, roam: true, zoom: 1.0,
                                label: { show: true, color: '#64748b' },
                                itemStyle: { areaColor: '#e2e8f0', borderColor: '#94a3b8', borderWidth: 1.5, shadowColor: 'rgba(0, 0, 0, 0.2)', shadowBlur: 10 },
                                emphasis: { itemStyle: { areaColor: '#cbd5e1' }, label: { color: '#0f172a' } }
                            },
                            series: [
                                {
                                    name: 'èƒ½æºèµ°å»Šè¾¹æ¡†', type: 'lines', coordinateSystem: 'geo', polyline: true,
                                    data: convertBeltBorderData(pBelts),
                                    lineStyle: { width: 26, color: 'rgba(255, 255, 255, 0.95)', cap: 'round', join: 'round', shadowBlur: 8, shadowColor: 'rgba(255, 255, 255, 0.8)' },
                                    silent: true, zlevel: 1.5
                                },
                                {
                                    name: 'èƒ½æºèµ°å»Š', type: 'lines', coordinateSystem: 'geo', polyline: true,
                                    data: convertBeltFillData(pBelts),
                                    lineStyle: { width: 20, opacity: 0.65, cap: 'round', join: 'round' },
                                    silent: false, zlevel: 1.6
                                },
                                {
                                    name: 'èƒ½æºåŸºåœ°', type: 'effectScatter', coordinateSystem: 'geo',
                                    data: convertPointData(pPoints),
                                    symbolSize: 18, showEffectOn: 'render', rippleEffect: { brushType: 'fill', scale: 2 },
                                    hoverAnimation: true, label: { show: false }, zlevel: 2
                                }
                            ]
                        };
                    }

                    chart.setOption(option);
                    setLoading(false);

                    chart.off('click');
                    chart.on('click', (params) => {
                        if (mode === 'china') {
                            if (params.componentType !== 'series' || params.seriesType !== 'map') return;
                            const clickedName = params.name;
                            if (adcodeMap[clickedName] && currentData.details[clickedName]) {
                                setCurrentProvince(clickedName);
                                setSelectedProvinceInfo(currentData.details[clickedName]);
                                setViewMode('province');
                            } else {
                                const provinceInfo = currentData.details[clickedName];
                                if (provinceInfo) {
                                    setSelectedProvinceInfo(provinceInfo);
                                } else {
                                    // ç®€å•çš„fallbackå¤„ç†ï¼Œç”µèƒ½é‡å¸‚åœºå¯èƒ½æ²¡æœ‰æ¢¯é˜Ÿä¿¡æ¯
                                    if (marketType === 'frequency') {
                                        // ... åŸæœ‰çš„æ¢¯é˜Ÿé€»è¾‘ ...
                                        setSelectedProvinceInfo(null);
                                    } else {
                                        setSelectedProvinceInfo(null);
                                    }
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error('Map loading failed:', error);
                    setLoading(false);
                }
            };

            // ç›‘å¬å˜åŒ–
            useEffect(() => {
                loadMap(viewMode, currentProvince);
            }, [viewMode, currentProvince, marketType, energyView]); // å¢åŠ  marketType ä¾èµ–

            // åˆ‡æ¢å¸‚åœºæ—¶é‡ç½®è§†å›¾
            useEffect(() => {
                setViewMode('china');
                setCurrentProvince(null);
                setSelectedProvinceInfo(null);
                if (marketType !== 'energy') {
                    setEnergyView('price');
                }
            }, [marketType]);

            useEffect(() => {
                if (marketType === 'energy') {
                    setViewMode('china');
                    setCurrentProvince(null);
                    setSelectedProvinceInfo(null);
                }
            }, [energyView, marketType]);

            useEffect(() => {
                const handleResize = () => chartInstanceRef.current && chartInstanceRef.current.resize();
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const handleBack = () => {
                setViewMode('china');
                setCurrentProvince(null);
                setSelectedProvinceInfo(null); 
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden relative">
                    <header className="bg-white shadow-sm border-b border-slate-200 px-6 py-4 flex items-center justify-between z-10 shrink-0 relative">
                        <div className="flex items-center space-x-3">
                            {viewMode === 'province' ? (
                                <button onClick={handleBack} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium">
                                    <ArrowLeft size={16} /> è¿”å›å…¨å›½
                                </button>
                            ) : (
                                <div className={`bg-gradient-to-br ${currentPalette.gradientFrom} ${currentPalette.gradientTo} p-2.5 rounded-xl text-white shadow-md transition-all duration-500`}>
                                    <Activity size={24} />
                                </div>
                            )}
                            
                            <div>
                                <h1 className="text-xl font-bold text-slate-900 tracking-tight">
                                    {viewMode === 'province' ? `${currentProvince}è¯¦æƒ…` : (marketType === 'frequency' ? 'äºŒæ¬¡è°ƒé¢‘å¸‚åœºçƒ­åŠ›å›¾' : 'ç”µèƒ½é‡å¸‚åœºçƒ­åŠ›å›¾')}
                                </h1>
                                <div className="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                    <span className={`px-1.5 py-0.5 rounded border flex items-center gap-1 ${currentPalette.iconBg} ${currentPalette.iconText} ${currentPalette.iconBorder}`}>
                                        {viewMode === 'province' ? <MapIcon size={12} /> : <Zap size={12} fill="currentColor" />}
                                        <span>{viewMode === 'province' ? 'çœå†…å¾®è§‚è§†è§’' : 'å…¨å›½å®è§‚è§†è§’'}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="flex-1 relative w-full h-full overflow-hidden">
                        <div className="w-full h-full bg-slate-50 flex">
                            
                            {/* --- å·¦ä¾§ä¼¸ç¼©é¢æ¿ --- */}
                            <div className={`absolute left-0 top-0 bottom-0 z-40 bg-white/95 backdrop-blur shadow-xl border-r border-slate-200 transition-all duration-300 ease-in-out flex flex-col ${isSidebarOpen ? 'w-72 translate-x-0' : 'w-0 -translate-x-full overflow-hidden'}`}>
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                                    <div className="flex items-center gap-2 text-slate-700 font-bold">
                                        <Layers size={18} />
                                        <span>å¸‚åœºè§†å›¾åˆ‡æ¢</span>
                                    </div>
                                </div>
                                
                                <div className="p-4 overflow-y-auto flex-1 space-y-6">
                                    
                                    {/* 0. å¸‚åœºç±»å‹åˆ‡æ¢å™¨ (æ ¸å¿ƒåŠŸèƒ½) */}
                                    <div className="p-1 bg-slate-100 rounded-lg flex gap-1">
                                        <button
                                            onClick={() => setMarketType('frequency')}
                                            className={`flex-1 py-2 px-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 ${marketType === 'frequency' ? 'bg-white text-red-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <Activity size={14} /> äºŒæ¬¡è°ƒé¢‘
                                        </button>
                                        <button 
                                            onClick={() => setMarketType('energy')}
                                            className={`flex-1 py-2 px-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 ${marketType === 'energy' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <BatteryCharging size={14} /> ç”µèƒ½é‡
                                        </button>
                                    </div>

                                    {marketType === 'energy' && (
                                        <div className="space-y-2">
                                            <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">ç”µèƒ½é‡è§†å›¾</div>
                                            <div className="grid grid-cols-3 gap-2 text-xs font-semibold">
                                                <button
                                                    onClick={() => setEnergyView('price')}
                                                    className={`px-2 py-2 rounded-lg border transition-all ${energyView === 'price' ? 'bg-white text-amber-700 border-amber-200 shadow-sm' : 'bg-slate-50 text-slate-500 border-slate-100 hover:text-slate-700'}`}
                                                >ä»·å·®çƒ­åŠ›å›¾</button>
                                                <button
                                                    onClick={() => setEnergyView('policy-long')}
                                                    className={`px-2 py-2 rounded-lg border transition-all ${energyView === 'policy-long' ? 'bg-white text-indigo-700 border-indigo-200 shadow-sm' : 'bg-slate-50 text-slate-500 border-slate-100 hover:text-slate-700'}`}
                                                >ä¸­é•¿æœŸæ”¿ç­–</button>
                                                <button
                                                    onClick={() => setEnergyView('policy-spot')}
                                                    className={`px-2 py-2 rounded-lg border transition-all ${energyView === 'policy-spot' ? 'bg-white text-blue-700 border-blue-200 shadow-sm' : 'bg-slate-50 text-slate-500 border-slate-100 hover:text-slate-700'}`}
                                                >ç°è´§æ”¿ç­–</button>
                                            </div>
                                            <div className="text-[11px] text-slate-500">åˆ‡æ¢ä»·å·®çƒ­åŠ›ä¸æ”¿ç­–è¿›ç¨‹çƒ­åŠ›å›¾ï¼Œé»˜è®¤ä¿æŒå…¨å›½è§†è§’ã€‚</div>
                                        </div>
                                    )}

                                    {/* 1. æ”¶ç›Š/çƒ­åº¦å›¾ä¾‹ */}
                                    {viewMode === 'china' && (
                                        <div className="space-y-3 animate-in fade-in slide-in-from-left-4 duration-500">
                                            <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                {marketType === 'frequency' ? 'è°ƒé¢‘æ”¶ç›Š (çƒ­åº¦)' : (energyView === 'price' ? 'ç”µèƒ½é‡ä»·å·®çƒ­åŠ›å›¾' : 'ç”µèƒ½é‡æ”¿ç­–çƒ­åŠ›å›¾')}
                                            </div>
                                            {marketType === 'frequency' ? (
                                                <div className="flex items-center gap-3">
                                                    <div className="h-32 w-2 rounded-full shadow-inner bg-gradient-to-b from-[#991b1b] via-[#ea580c] to-[#fef08a]"></div>
                                                    <div className="flex flex-col justify-between h-32 text-xs text-slate-600 font-medium">
                                                        <span>é«˜</span>
                                                        <span>ä¸­é«˜</span>
                                                        <span>ä¸­</span>
                                                        <span>ä¸­ä½</span>
                                                        <span>ä½</span>
                                                    </div>
                                                </div>
                                            ) : energyView === 'price' ? (
                                                <div className="space-y-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="h-24 w-3 rounded-full shadow-inner bg-gradient-to-b from-[#fef3c7] via-[#fde68a] to-[#f59e0b]"></div>
                                                        <div className="flex flex-col justify-between h-24 text-[11px] text-slate-600 font-medium">
                                                            <span>å®æµ‹é«˜</span>
                                                            <span>å®æµ‹ä¸­é«˜</span>
                                                            <span>å®æµ‹ä¸­</span>
                                                            <span>å®æµ‹ä¸­ä½</span>
                                                            <span>å®æµ‹ä½</span>
                                                        </div>
                                                        <span className="text-[11px] text-amber-700 font-semibold px-2 py-1 bg-amber-50 border border-amber-100 rounded">å®æµ‹çœä»½</span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <div className="h-24 w-3 rounded-full shadow-inner bg-gradient-to-b from-[#f0f9ff] via-[#7dd3fc] to-[#0ea5e9]"></div>
                                                        <div className="flex flex-col justify-between h-24 text-[11px] text-slate-600 font-medium">
                                                            <span>å¸‚åœºé«˜</span>
                                                            <span>å¸‚åœºä¸­é«˜</span>
                                                            <span>å¸‚åœºä¸­</span>
                                                            <span>å¸‚åœºä¸­ä½</span>
                                                            <span>å¸‚åœºä½</span>
                                                        </div>
                                                        <span className="text-[11px] text-sky-700 font-semibold px-2 py-1 bg-sky-50 border border-sky-100 rounded">å¸‚åœºåŒºé—´çœä»½</span>
                                                    </div>
                                                    <div className="text-[11px] leading-relaxed text-slate-600 bg-slate-50 border border-slate-100 rounded-lg p-2">
                                                        å®æµ‹çœä»½ï¼ˆå–å•ç‚¹å€¼ç»˜åˆ¶ï¼‰ï¼š{actualDataProvinces.join('ã€')}ã€‚
                                                        å¸‚åœºåŒºé—´çœä»½æŒ‰ç»™å®šèŒƒå›´å–ä¸­å€¼ç»˜åˆ¶ï¼Œç‚¹å‡»å¯æŸ¥çœ‹åŸå§‹åŒºé—´ä¸å¤‡æ³¨ã€‚
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="space-y-3">
                                                    <div className="flex items-center gap-3">
                                                        <div className="h-24 w-3 rounded-full shadow-inner" style={{ background: `linear-gradient(to bottom, ${policyColorScale[2]}, ${policyColorScale[1]}, ${policyColorScale[0]})` }}></div>
                                                        <div className="flex flex-col justify-between h-24 text-[11px] text-slate-600 font-medium">
                                                            <span>äº¤æ˜“ç»†åˆ™åŒ…å«å‚¨èƒ½</span>
                                                            <span>ç»è¥ä¸»ä½“åŒ…å«å‚¨èƒ½</span>
                                                            <span>æ— æ”¿ç­–</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-[11px] leading-relaxed text-slate-600 bg-slate-50 border border-slate-100 rounded-lg p-2">
                                                        æ— æ”¿ç­– = æœ€æµ…è‰²ï¼›ç»è¥ä¸»ä½“åŒ…å«å‚¨èƒ½ = ä¸­é—´è‰²ï¼›äº¤æ˜“ç»†åˆ™åŒ…å«å‚¨èƒ½ = æœ€æ·±è‰²ã€‚
                                                        åˆ‡æ¢ä¸­é•¿æœŸ / ç°è´§æŸ¥çœ‹ä¸åŒæ”¿ç­–è¿›ç¨‹çƒ­åŠ›å›¾ã€‚
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="border-t border-slate-100"></div>

                                    {/* 2. èƒ½æºåŸºåœ°ç±»å‹å›¾ä¾‹ */}
                                    <div className="space-y-3">
                                        <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">èƒ½æºåŸºåœ°å›¾ä¾‹</div>
                                        <div className="space-y-2 text-xs text-slate-700">
                                            {Object.entries(pointTypeConfig).map(([key, cfg]) => (
                                                <div key={key} className="flex items-center gap-2 p-2 rounded hover:bg-slate-50 transition-colors">
                                                    {cfg.symbol === 'circle' && <div className="w-3 h-3 rounded-full border border-white shadow-sm flex-shrink-0" style={{backgroundColor: cfg.color}}></div>}
                                                    {cfg.symbol === 'rect' && <div className="w-3 h-3 border border-white shadow-sm flex-shrink-0" style={{backgroundColor: cfg.color}}></div>}
                                                    {cfg.symbol === 'triangle' && <div className="w-3 h-3 border border-white shadow-sm flex-shrink-0" style={{backgroundColor: cfg.color, clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)'}}></div>}
                                                    {cfg.symbol === 'diamond' && <div className="w-3 h-3 border border-white shadow-sm flex-shrink-0 rotate-45" style={{backgroundColor: cfg.color}}></div>}
                                                    <span>{cfg.label}</span>
                                                </div>
                                            ))}
                                            <div className="flex items-center gap-2 p-2 rounded hover:bg-slate-50 transition-colors">
                                                <div className="w-8 h-3 bg-slate-300 rounded border border-white shadow-sm flex items-center justify-center relative flex-shrink-0">
                                                    <div className="w-6 h-1 bg-slate-400/50 rounded-full"></div>
                                                </div>
                                                <span className="text-slate-500">èµ°å»Š/äº§ä¸šå¸¦</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 3. æ¢¯é˜Ÿä¿¡æ¯ (ä»…è°ƒé¢‘æ˜¾ç¤º) */}
                                    {marketType === 'frequency' && viewMode === 'china' && (
                                        <>
                                            <div className="border-t border-slate-100"></div>
                                            <div className="space-y-3">
                                                <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">æ½œåœ¨å¸‚åœº (æ¢¯é˜Ÿ)</div>
                                                <div className="space-y-2 text-xs text-slate-700">
                                                    <div className="flex items-center gap-2"><div className="w-2.5 h-2.5 rounded bg-[#1d4ed8]"></div><span>ç¬¬ä¸€æ¢¯é˜Ÿ</span></div>
                                                    <div className="flex items-center gap-2"><div className="w-2.5 h-2.5 rounded bg-[#60a5fa]"></div><span>ç¬¬äºŒæ¢¯é˜Ÿ</span></div>
                                                    <div className="flex items-center gap-2"><div className="w-2.5 h-2.5 rounded bg-[#bfdbfe]"></div><span>ç¬¬ä¸‰æ¢¯é˜Ÿ</span></div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                    
                                    <div className="pt-4 text-center">
                                        <div className="text-[10px] text-slate-300 border border-dashed border-slate-200 rounded p-2 hover:border-slate-300 hover:text-slate-400 cursor-pointer transition-colors">
                                            + æ·»åŠ æ›´å¤šç­›é€‰å™¨ (é¢„ç•™)
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button 
                                onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                className={`absolute top-4 z-30 bg-white p-2 rounded-r-lg shadow-md border border-l-0 border-slate-200 text-slate-500 hover:text-slate-800 hover:bg-slate-50 transition-all duration-300 ${isSidebarOpen ? 'left-72' : 'left-0'}`}
                            >
                                {isSidebarOpen ? <ChevronLeft size={16} /> : <ChevronRight size={16} />}
                            </button>

                            <div className="flex-1 relative">
                                {loading && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 gap-3 bg-slate-50 z-50">
                                        <div className="w-8 h-8 border-4 border-current border-t-transparent rounded-full animate-spin text-blue-500"></div>
                                        <span className="text-sm">æ­£åœ¨é‡ç»˜åœ°å›¾...</span>
                                    </div>
                                )}
                                <div ref={mapContainerRef} className="w-full h-full cursor-pointer" />
                            </div>
                        </div>

                        {/* å³ä¾§è¯¦æƒ…é¢æ¿ */}
                        <div className={`absolute right-0 top-0 bottom-0 z-30 w-full md:w-[400px] bg-white shadow-2xl md:border-l border-slate-200 transform transition-transform duration-300 ease-in-out flex flex-col ${selectedProvinceInfo ? 'translate-x-0' : 'translate-x-full'}`}>
                            {selectedProvinceInfo && (
                                <>
                                    <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-gradient-to-br from-slate-50 to-white">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1"><h2 className="text-2xl font-bold text-slate-800">{selectedProvinceInfo.title}</h2></div>
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {selectedProvinceInfo.totalVolume && <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-bold border shadow-sm ${marketType === 'frequency' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200'}`}>æ€»é‡: {selectedProvinceInfo.totalVolume}</span>}
                                                {selectedProvinceInfo.tags && selectedProvinceInfo.tags.map((tag, i) => <span key={i} className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">{tag}</span>)}
                                            </div>
                                        </div>
                                        <button onClick={() => setSelectedProvinceInfo(null)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-all"><X size={24} /></button>
                                    </div>
                                    <div className="p-6 overflow-y-auto space-y-6 flex-1 bg-white">
                                        {/* åŠ¨æ€å¡ç‰‡é¢œè‰² */}
                                        <div className={`rounded-xl p-5 border shadow-sm relative overflow-hidden ${marketType === 'frequency' ? 'bg-white border-red-100 shadow-red-50/50' : 'bg-white border-indigo-100 shadow-indigo-50/50'}`}>
                                            {selectedProvinceInfo.heatValue > 0 && <div className={`absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl -mr-4 -mt-4 rounded-full opacity-50 ${marketType === 'frequency' ? 'from-red-50' : 'from-indigo-50'}`}></div>}
                                            <div className={`flex items-center gap-2 font-semibold mb-3 ${marketType === 'frequency' ? 'text-red-600' : 'text-indigo-600'}`}>
                                                {marketType === 'frequency' ? <Coins size={20} /> : <Zap size={20} />}
                                                <span>{marketType === 'frequency' ? 'è°ƒé¢‘æ”¶ç›Šæ¦‚è§ˆ' : 'ç”µèƒ½é‡å¸‚åœºæ¦‚è§ˆ'}</span>
                                            </div>
                                            <p className="text-lg text-slate-800 font-medium leading-relaxed">{selectedProvinceInfo.marketVolumeDisplay}</p>
                                        </div>
                                        
                                        {selectedProvinceInfo.details && (
                                            <div className="space-y-4">
                                                <div className="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-wider"><BarChart3 size={14} />è¯¦ç»†æ•°æ® / è°ƒç ”æƒ…å†µ</div>
                                                <div className="bg-slate-50 rounded-xl border border-slate-100 divide-y divide-slate-100">
                                                    {selectedProvinceInfo.details.map((item, idx) => (
                                                        <div key={idx} className="p-4 flex flex-col gap-1.5 hover:bg-slate-50/80 transition-colors">
                                                            <span className="text-xs text-slate-500 font-medium flex items-center gap-1"><span className="w-1 h-1 rounded-full bg-slate-400"></span>{item.label}</span>
                                                            <span className="text-slate-900 text-sm leading-relaxed pl-2 border-l-2 border-slate-200">{item.value}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnergyMarketMap />);
    </script>
</body>

</html>
